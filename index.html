<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Arkanoid - Eric Garcia Reverter</title>
    <script src="./phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('fondo', 'assets/fondo.png');
    game.load.image('bloc', 'assets/bloc.png');
    game.load.image('barra', 'assets/barra.png');
    game.load.image('pilota', 'assets/pilota.png');
		game.load.spritesheet('heart', 'assets/hearts.png', 300, 300, 3);

}

var player
var cursors
var ball

var blocs
var score = -1000
var lives = 9
var level = 0
var livesText
var scoreText
var progressLevel
var levelText

var estat = ''

var velocity = 250;

var progressBar


function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //  A simple background for our game
    game.add.sprite(0, 0, 'fondo');

    scoreText = game.add.text(16, 8, 'Score: 0', { fontSize: '32px', fill: '#000' });
		progressLevel = game.add.text(game.world.centerX-128, 8, 'Punts restants: ', { fontSize: '32px', fill: '#000' });
    livesText = game.add.text(688, 8, 'Lives: '+lives, { fontSize: '32px', fill: '#000' });
    levelText = game.add.text(game.world.centerX-64, game.world.height/2, 'LEVEL '+level, { font: "40px Arial", fill: "#ffffff", align: "center" });



    newLevel()

		var scale = 0.1
		cors = []

		for (var i = 0; i < lives; i++) {
			cors.push(game.add.sprite(10+(30*i), game.world.height-40, 'heart',0))
			cors[i].scale.setTo(scale)
		}

		progressBar = game.add.graphics(0,0);
		progressBar.beginFill(0xFF3300);
    progressBar.drawRect(game.world.width/2,game.world.height-40, (32-blocs.countLiving())*10,10);
    progressBar.endFill();

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
}

function update() {

	progressLevel.text = 'Nivell completat: ' + ((32-blocs.countLiving())/32)*100+'%'


    if (estat != 'acabat'){

        game.physics.arcade.collide(player, ball)
        game.physics.arcade.collide(ball, blocs, touchBlock, null, this)

        if (ball.body.y > 540){
            ball.kill()

            livesText.text = 'Lives: ' + --lives
						cors[lives].frame = 2
            resetBall()
            player.body.x = game.world.width/2-48
            estat = ''
        }

        //  Reset the players velocity (movement)
        player.body.velocity.x = 0;
        if (estat == ''){
            ball.body.velocity.x = 0;
        }

        if (cursors.left.isDown)
        {
            player.body.velocity.x = -velocity;
        }
        else if (cursors.right.isDown)
        {
            player.body.velocity.x = velocity;
        }
        else if (game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR).isDown && estat == ''){
            estat = 'jugant'
            ball.body.velocity.x = velocity;
            ball.body.velocity.y = -velocity;
        }
        if (estat == ''){
            ball.body.x = player.body.x-12+player.width/2
        }
    }

    if (lives == 0){
        game.world.remove(levelText)
        game.add.text(game.world.centerX-232, game.world.height/2, 'GAME OVER!\nYOU SURVIVED ' + level +' LEVEL'+(level == 1 ? '' : 'S'), { font: "40px Arial", fill: "#ffffff", align: "center" });
        estat = 'acabat'
    }
    if (blocs.countLiving() == 0){
        player.kill()
        ball.kill()
        newLevel()
    }
}

function newLevel(){
    resetPlayer()
    resetBall()
    resetBlocks()
    levelText.text = 'LEVEL ' + ++level;
    score += 1000
    velocity += 100
    estat = ''
}

function resetBlocks(){
    blocs = game.add.group();
    blocs.enableBody = true;

    for (var j = 0; j < 4; j++){
        for (var i = 0; i < 8; i++)
        {
            var bloc = blocs.create(i * 96+16, j*24+40, 'bloc');
            bloc.body.immovable = true;
        }
    }
}

function resetPlayer(){
    player = game.add.sprite(game.world.width/2-48, game.world.height*0.9, 'barra');
    game.physics.arcade.enable(player);
    player.body.collideWorldBounds = true;
    player.body.immovable = true;
}

function resetBall(){
    ball = game.add.sprite(game.world.width/2-60+player.width/2, game.world.height*0.9-player.height, 'pilota');
    game.physics.arcade.enable(ball);
    ball.body.bounce.x = 1;
    ball.body.bounce.y = 1;
    ball.body.collideWorldBounds = true;
}

function touchBlock (player, bloc) {
    bloc.kill();
    score += 10;
    scoreText.text = 'Score: ' + score;
}

</script>

</body>
</html>
